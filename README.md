# ğŸ¤– AI Smarttalk React Hooks

[![Tests](https://github.com/AI-SmartTalk/aismarttalk-react-hooks/actions/workflows/test.yml/badge.svg)](https://github.com/AI-SmartTalk/aismarttalk-react-hooks/actions/workflows/test.yml)
[![codecov](https://codecov.io/gh/AI-SmartTalk/aismarttalk-react-hooks/branch/main/graph/badge.svg)](https://codecov.io/gh/AI-SmartTalk/aismarttalk-react-hooks)
[![npm version](https://img.shields.io/npm/v/@aismarttalk/react-hooks.svg)](https://www.npmjs.com/package/@aismarttalk/react-hooks)
[![License](https://img.shields.io/github/license/AI-SmartTalk/aismarttalk-react-hooks)](https://github.com/AI-SmartTalk/aismarttalk-react-hooks/blob/main/LICENSE)

A collection of high-quality, reusable React hooks for integrating [AI Smarttalk](https://aismarttalk.tech)'s [AI Agents](https://aismarttalk.tech) into your React application. This library provides hooks for managing chat messages, user state, and chat instance initialization with robust error handling, token validation, and localStorage persistence.

---

## âœ¨ Features

### ğŸ’¬ Chat Interface for the AI Agent

- ğŸ”„ Manage chat messages, WebSocket connections, typing notifications, and conversation history with a flexible configuration
- ğŸ‘¤ Handle user state with localStorage persistence, token validation (JWT), and automatic fallback to an anonymous user if needed
- ğŸš€ Initialize or reset a chat instance based on a given chat model and language, using API calls to create new instances when required

### ğŸ“ Canvas System
The library includes a powerful canvas system for handling structured text content (like code or documents):

- ğŸ¤ **Real-time collaborative text editing** with automatic synchronization across all connected clients
- âœï¸ **Line-by-line manipulation** with support for inserting, updating, and deleting lines
- ğŸ“š **History tracking** with localStorage persistence
- ğŸ”¢ **Formatted output** with line numbers for AI interactions
- ğŸ”„ **Simple text conversion** for easy integration with LLMs

#### Example usage:
```tsx
const ChatComponent = () => {
  const {
    messages,
    canvasHistory, // Access the canvas system
    // ... other chat features
  } = useAISmarttalkChat({
    chatModelId: 'your-model-id',
    lang: 'en',
    config: {
      apiUrl: 'https://aismarttalk.tech',
      wsUrl: 'wss://ws.223.io.aismarttalk.tech',
      apiToken: 'your-api-token',
    },
  });

  // Store code generated by AI
  const handleAICode = (code: string[]) => {
    canvasHistory.updateCanvas({
      title: "Generated Code",
      content: code
    });
  };

  // Get formatted code with line numbers for AI context
  const getNumberedCode = () => {
    return canvasHistory.getNumberedLines();
  };

  // Update specific lines
  const updateLine = (lineNumber: number, newContent: string) => {
    canvasHistory.updateLineRange(lineNumber, lineNumber, [newContent]);
  };

  return (
    // Your chat UI implementation
  );
};
```

The canvas system maintains synchronization across all connected clients automatically through WebSocket events, making it perfect for collaborative code review and document editing scenarios.

---

## ğŸš€ Installation

Install the package via npm or yarn:

```bash
npm install @aismarttalk/react-hooks
# or
yarn add @aismarttalk/react-hooks
```

> ğŸ’¡ _Note: Replace `@aismarttalk/react-hooks` with the actual package name if different._

---

## ğŸ Getting Started

### Using `useAiSmarttalkChat`

```tsx
import { useAISmarttalkChat } from '@aismarttalk/react-hooks';

const ChatComponent = () => {
  const {
    messages,
    addMessage,
    user,
    setUser,
    chatInstanceId,
    resetChat,
    socketStatus,
    error,
    clearError,
    // ... and more
  } = useAISmarttalkChat({
    chatModelId: 'your-model-id',
    lang: 'en',
    config: {
      apiUrl: 'https://aismarttalk.tech',
      wsUrl: 'wss://ws.223.io.aismarttalk.tech',
      apiToken: 'your-api-token',
    },
  });

  return (
    // Your chat UI implementation
  );
};
```

### Using the Enhanced Error Handling System

The 1.5.0 update introduces a comprehensive error handling system that provides structured error information:

```tsx
import { useAISmarttalkChat } from '@aismarttalk/react-hooks';

const ChatComponent = () => {
  const { error, clearError, onSend, messages } = useAISmarttalkChat({
    chatModelId: 'your-model-id',
    lang: 'en',
    config: {
      apiUrl: 'https://aismarttalk.tech',
      apiToken: 'your-api-token',
    },
  });

  // Error contains structured information
  // error = {
  //   message: "Unauthorized: You need to login to access this chat.",
  //   type: "auth",
  //   code: 401
  // }

  const renderErrorMessage = () => {
    if (!error.message) return null;
    
    // You can customize UI based on error type
    switch (error.type) {
      case 'auth':
        return (
          <div className="error auth-error">
            ğŸ”’ {error.message}
            <button onClick={() => handleLogin()}>Login</button>
          </div>
        );
      case 'permission':
        return <div className="error permission-error">â›” {error.message}</div>;
      case 'rate_limit':
        return <div className="error rate-limit-error">â±ï¸ {error.message}</div>;
      case 'server':
        return <div className="error server-error">
          ğŸ”§ {error.message}
          <small>Error code: {error.code}</small>
        </div>;
      default:
        return <div className="error">{error.message}</div>;
    }
  };

  return (
    <div className="chat-container">
      {renderErrorMessage()}
      <div className="messages">
        {messages.map(msg => (
          <div key={msg.id} className={msg.isSent ? 'sent' : 'received'}>
            {msg.text}
          </div>
        ))}
      </div>
      {/* Rest of chat UI */}
    </div>
  );
};
```

### Using `useChatInstance`

```tsx
import React from 'react';
import useChatInstance from '@aismarttalk/react-hooks/hooks/useChatInstance';

const ChatInstanceComponent = () => {
  const { chatInstanceId, resetInstance, error } = useChatInstance({
    chatModelId: 'your-model-id',
    lang: 'en',
    config: {
      apiUrl: 'https://aismarttalk.tech',
      apiToken: 'your-api-token',
    },
    user: { token: 'user-token' },
  });

  return (
    <div>
      {error && <p style={{ color: 'red' }}>{error.message}</p>}
      <h3>Chat Instance ID: {chatInstanceId}</h3>
      <button onClick={resetInstance}>Reset Chat Instance</button>
    </div>
  );
};

export default ChatInstanceComponent;
```

## ğŸ”„ Message Handling Improvements

### Message Deduplication System

Version 1.5.0 implements an intelligent message deduplication system that solves several common issues in real-time chat applications:

1. **Temporary to Permanent Message Transition**
   - When a user sends a message, it's immediately displayed with a temporary ID
   - When the WebSocket returns the server-validated message (with a permanent ID), the system smartly replaces the temporary message instead of showing a duplicate

2. **"isSent" Property Calculation**
   - Messages are now correctly marked as "sent by current user" based on comprehensive identity checks
   - Works reliably for both authenticated users and anonymous sessions
   - Prevents UI inconsistencies where your own messages might temporarily appear as coming from someone else

3. **Flickering Prevention**
   - Intelligent API refresh throttling when messages arrive via WebSocket
   - Optimized message merging with preservation of user-specific properties
   - Smart timestamp tracking to avoid unnecessary UI updates

### Example Flow:

```tsx
// Your component
const ChatComponent = () => {
  const { messages, onSend } = useAISmarttalkChat({...config});
  
  // When a user sends a message:
  const handleSend = (text) => {
    onSend(text);
    // 1. Message immediately appears in the UI (with temp ID)
    // 2. Message is sent to the server
    // 3. Server processes and broadcasts via WebSocket
    // 4. Hook receives the WebSocket message
    // 5. Deduplication system identifies and replaces temp message
    // 6. UI smoothly updates with no duplicates or flickering
  };
  
  return (
    <div>
      {messages.map(msg => (
        <div key={msg.id} className={msg.isSent ? 'sent' : 'received'}>
          {msg.text}
        </div>
      ))}
      <button onClick={() => handleSend("Hello world!")}>Send</button>
    </div>
  );
};
```

This deduplication system works behind the scenes without requiring any special handling in your components.

## ğŸ“ Changelog

### 1.5.0 âœ¨ Enhanced Error Handling & Message Stability
- ğŸ›¡ï¸ **Comprehensive Error Handling System**
  - Added structured error information with types (`auth`, `permission`, `rate_limit`, etc.)
  - Improved HTTP status code handling (401, 403, 429, etc.)
  - Enhanced error reporting with consistent formatting
- ğŸ”„ **Message Deduplication & Stability Improvements**
  - Fixed temporary message duplication when receiving WebSocket responses
  - Improved handling of message ownership and `isSent` property calculation
  - Enhanced temporary to permanent message transition for smoother UX
  - Fixed bug where messages would appear duplicated for a split second when sent
  - Solved issues with `isSent` property not being correctly calculated for logged-in users
  - Improved message ID tracking between temporary and permanent versions
- âš¡ **Performance Optimizations**
  - Reduced API refresh flickering with better message merging
  - Added intelligent caching to prevent unnecessary refreshes
  - Improved WebSocket reconnection logic
  - Added lastMessageReceivedRef tracking to prevent unnecessary API calls
  - Enhanced message merging algorithm to preserve UI state during updates

### 1.4.0 âœ¨ Introduce useOtpAuth for Login
- ğŸ”‘ Added `useOtpAuth` hook to facilitate user login via OTP.
- ğŸ§¹ Removed unnecessary console logs to clean up the codebase.
- âš¡ Improved caching mechanisms for better performance.
- ğŸ“œ Enhanced chat history management for a more reliable user experience.


### 1.3.0 âœ¨ Add User Config
- ğŸ› ï¸ Allow user configuration 
```ts
const { user, messages, onSend /* ... other values */ } = useAISmarttalkChat({
  chatModelId: "your-chat-model-id",
  config: {
    apiUrl: "your-api-url",
    user: {
      id: "custom-user-id",
      email: "custom@email.com",
      name: "Custom User",
      // Optional fields
      image: "https://example.com/avatar.jpg",
      token: "your-auth-token"
    }
  }
});
```

### 1.2.4 Refactor: Split Responsibilities of useMessage
- ğŸ”„ Restructured the useMessage hook to separate concerns, enhancing maintainability.
- âœ… Added support for features, enabling the client to communicate with the API regarding supported features (currently only Canva).

### 1.2.3 Enhanced History Management for Uninitialized States
- ğŸ”„ Improved handling of chat history when it has not been initialized yet, ensuring a smoother user experience.
- âœ… Added checks to prevent errors when accessing uninitialized history, providing fallback mechanisms.
- ğŸ“ˆ Optimized performance for loading and displaying chat history

### 1.2.2 - Fix User Token expiration
- ğŸ› Fixed user token expiration validation causing incorrect message attribution
- ğŸ”„ Added proper token expiry checks to prevent wrong user identification
- âœ… Improved user session handling and authentication validation

### 1.2.1 - Fix Regression
- ğŸ› Fixed regression where suggestions were not being returned from useAISmarttalkChat hook
- ğŸ”„ Restored suggestions functionality to maintain expected behavior
- âœ… Added additional validation to prevent future regressions

### 1.2.0 - Canvas System Update
- âœ¨ Added canvas system for structured text handling
- ğŸ”„ Real-time collaborative editing support
- ğŸ“š Local history tracking
- ğŸ”¢ Line number formatting utilities

### 1.1.1 - 1.1.3 - Maintenance
- ğŸ› Fix hardcoded urls in getChatModel
- ğŸ§¹ Refactor and remove duplicated code

### 1.1.0 - Major Update
- ğŸ‰ Introducing consolidated `useAISmarttalkChat` hook
- ğŸ“¦ Simplified integration with reduced boilerplate
- ğŸ”§ Enhanced TypeScript support
- âš¡ Improved performance

---

## ğŸ“„ License

This project is licensed under the [Apache 2.0 Licence](LICENSE).

---

## ğŸ“ Contact

For questions or support, please [open an issue](../../issues) on the repository or contact the maintainer.

---

## ğŸŒŸ Contributing

We welcome contributions! Please feel free to submit a Pull Request.

---

Enjoy integrating chat functionality with [AI Smarttalk](https://aismarttalk.tech) React Hooks! ğŸš€